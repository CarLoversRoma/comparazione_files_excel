<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confronto Excel â€“ Standalone Pro (no-Babel)</title>
  <!-- Dipendenze UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --fg: #1e293b;
      --muted: #475569;
      --muted-2: #64748b;
      --card: #ffffff;
      --border: #e2e8f0;
      --brand: #4f46e5;
      --brand-600: #4338ca;
      --header: #f1f5f9;
      --modified: #fef9c3;
      --added: #dcfce7;
      --removed: #fee2e2;
      --toast-bg: #111827;
      --toast-fg: #f9fafb;
    }
    .dark {
      --bg: #0b1220;
      --fg: #e5e7eb;
      --muted: #94a3b8;
      --muted-2: #a1a1aa;
      --card: #0f1629;
      --border: #1f2a44;
      --brand: #818cf8;
      --brand-600: #6366f1;
      --header: #101a33;
      --modified: #4b5563;
      --added: #1f3b2d;
      --removed: #3b1f1f;
      --toast-bg: #111827;
      --toast-fg: #f9fafb;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    .header { display:flex; gap: 1rem; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    .header h1 { font-size: 1.875rem; margin: 0; }
    .header p { color: var(--muted); margin: .25rem 0 0; }
    .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: .75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
    .card-title { font-weight: 600; margin-bottom: .75rem; }
    .muted { color: var(--muted-2); }
    .file-drop { border: 2px dashed var(--border); border-radius: .75rem; padding: 2rem; text-align: center; cursor: pointer; }
    .file-drop:hover { background: rgba(79,70,229,.06); border-color: var(--brand); }
    .file-info { display:flex; align-items:center; justify-content: space-between; background: var(--header); border-radius: .5rem; padding: .75rem; }
    .btn { appearance:none; border:1px solid var(--border); background:#fff0; color: var(--fg); padding: .6rem .9rem; border-radius: .5rem; cursor: pointer; font-weight: 600; }
    .btn.primary { background: var(--brand); color: white; border-color: transparent; }
    .btn.primary:disabled { opacity:.6; cursor:not-allowed; }
    .btn.primary:hover:not(:disabled) { background: var(--brand-600); }
    .btn.ghost { background: transparent; }
    .btn.secondary { background: var(--card); }
    .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; }
    .tabs { display:flex; gap:.25rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap; }
    .tab { border:none; background: transparent; padding: .75rem 1rem; border-bottom: 2px solid transparent; cursor:pointer; color: var(--muted); font-weight:600; }
    .tab.active { color: var(--brand); border-bottom-color: var(--brand); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:.75rem; }
    .alert { background: #fee2e2; color:#991b1b; border:1px solid #fecaca; padding: .75rem 1rem; border-radius:.5rem; }
    .actions { display:flex; justify-content: space-between; gap:.5rem; align-items:center; margin: .75rem 0; flex-wrap: wrap; }
    .search { display:flex; gap:.5rem; align-items:center; }
    .search input, select, .checkboxes { padding:.5rem .6rem; border:1px solid var(--border); background:var(--card); color:var(--fg); border-radius:.5rem; }
    .checkboxes { display:flex; gap:.5rem; align-items:center; }
    .table-wrap { border:1px solid var(--border); border-radius:.5rem; height: 520px; overflow: auto; position: relative; background: var(--card); }
    table { width:100%; border-collapse: collapse; }
    thead th { position: sticky; top: 0; background: var(--header); text-align:left; padding:.6rem; font-size:.78rem; text-transform: uppercase; border-bottom:1px solid var(--border); }
    tbody td { padding:.6rem; border-bottom:1px solid var(--border); }
    tr:hover { background: rgba(0,0,0,.03); }
    .row-mod { background: var(--modified); }
    .row-add { background: var(--added); }
    .row-rem { background: var(--removed); }
    .old { text-decoration: line-through; opacity: .9; font-size: .78rem; }
    .new { font-weight: 700; }
    .legend { font-size:.85rem; color: var(--muted-2); margin-bottom: .5rem; }
    .switch { display:flex; align-items:center; gap:.5rem; }
    .switch input { width: 42px; height: 22px; }
    .footer { text-align:center; margin-top:1rem; color: var(--muted-2); font-size:.9rem; }
    .toast { position: fixed; right: 1rem; bottom: 1rem; background: var(--toast-bg); color: var(--toast-fg); padding: .75rem 1rem; border-radius:.5rem; box-shadow: 0 4px 14px rgba(0,0,0,.25); opacity:0; transform: translateY(8px); transition: all .25s; z-index:60; }
    .toast.show { opacity:1; transform: translateY(0); }
    /* Virtual rows */
    .spacer { height: var(--spacer-h, 0px); }
    /* Sticky stats bar */
    .sticky-stats { position: sticky; top: 0; z-index: 45; background: var(--bg); border-bottom: 1px solid var(--border); padding: .5rem 0; margin-bottom: 1rem; }
    .stats-bar { display:flex; gap:.5rem; }
    .pill { flex:1; text-align:center; font-weight:800; padding:.6rem .75rem; border-radius:.5rem; }
    .pill.modified { background: var(--modified); }
    .pill.added { background: var(--added); }
    .pill.removed { background: var(--removed); }
  </style>
</head>
<body>
  <noscript>Per favore abilita JavaScript.</noscript>
  <div id="root"></div>

  <script>
  (function(){
    const h = React.createElement;

    // === Persistenza ===
    const store = {
      get: function(key, fallback){
        try { var v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
      },
      set: function(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }
    };

    // === Utility normalizzazione ===
    function normalize(value, opts){
      if (value === null || value === undefined) return '';
      var s = String(value);
      if (opts && opts.trimWhitespace) s = s.trim();
      if (opts && opts.ignoreCase) s = s.toLowerCase();
      return s;
    }

    // === Diff ===
    function buildDiff(ctx){
      var A = ctx.A, B = ctx.B, keyColA = ctx.keyColA, mapAB = ctx.mapAB, options = ctx.options, excludedCols = ctx.excludedCols;
      var result = { modified: [], added: [], removed: [] };
      if (!A || !B || !keyColA || keyColA === '__CONTENT__') return result;
      var keyColB = mapAB[keyColA];
      var mapA = new Map(A.data.map(function(r){ return [r[keyColA], r]; }));
      var mapB = new Map(B.data.map(function(r){ return [r[keyColB], r]; }));
      mapA.forEach(function(rowA, k){
        if (mapB.has(k)){
          var rowB = mapB.get(k);
          var changes = [];
          Object.keys(mapAB).forEach(function(colA){
            var colB = mapAB[colA];
            if (!colB) return; // ignorata
            if (excludedCols && (excludedCols.indexOf(colA) >= 0 || excludedCols.indexOf(colB) >= 0)) return;
            var va = normalize(rowA[colA], options);
            var vb = normalize(rowB[colB], options);
            if (va !== vb) changes.push({ headerA: colA, headerB: colB, oldValue: rowA[colA], newValue: rowB[colB] });
          });
          if (changes.length) result.modified.push({ key:k, rowDataA: rowA, rowDataB: rowB, changes: changes });
          mapB.delete(k);
        } else {
          result.removed.push(rowA);
        }
      });
      result.added = Array.from(mapB.values());
      return result;
    }

    // === Export util ===
    function exportDiffExcel(result){
      var wb = XLSX.utils.book_new();
      if (result.modified.length){
        var rows = result.modified.map(function(m){ return Object.assign({}, m.rowDataB, {_changedCols: m.changes.map(function(c){return c.headerB;}).join(', ')}); });
        var ws = XLSX.utils.json_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, 'Modificati');
      }
      if (result.added.length){
        var wsA = XLSX.utils.json_to_sheet(result.added);
        XLSX.utils.book_append_sheet(wb, wsA, 'Aggiunti');
      }
      if (result.removed.length){
        var wsR = XLSX.utils.json_to_sheet(result.removed);
        XLSX.utils.book_append_sheet(wb, wsR, 'Rimossi');
      }
      XLSX.writeFile(wb, 'report_confronto.xlsx');
    }

    function exportSingleExcel(fileId, result, fileData, keyColumn, mapAB){
      var wb = XLSX.utils.book_new();
      var data = fileData[fileId].data;
      var exportRows = data.map(function(row){
        var o = Object.assign({}, row);
        var rowKey = (keyColumn && keyColumn !== '__CONTENT__') ? (fileId === 'A' ? row[keyColumn] : row[ mapAB[keyColumn] ]) : null;
        if (rowKey && result){
          if (fileId === 'A'){
            var mod = result.modified.find(function(m){return m.key === rowKey;});
            var rem = result.removed.find(function(r){return r[keyColumn] === rowKey;});
            o.__STATO__ = mod ? 'MODIFICATO' : (rem ? 'RIMOSSO' : 'INVARIATO');
          } else {
            var mappedKey = mapAB[keyColumn];
            var modB = result.modified.find(function(m){return m.key === rowKey;});
            var add = result.added.find(function(r){return r[mappedKey] === rowKey;});
            o.__STATO__ = modB ? 'MODIFICATO' : (add ? 'AGGIUNTO' : 'INVARIATO');
          }
        }
        return o;
      });
      var ws = XLSX.utils.json_to_sheet(exportRows);
      XLSX.utils.book_append_sheet(wb, ws, 'File ' + fileId);
      XLSX.writeFile(wb, 'file_' + fileId + '_con_differenze.xlsx');
    }

    // === Worker parsing (facoltativo) ===
    function createParserWorker(){
      try {
        var workerCode = "self.onmessage = function(e){\\n  var buf = e.data.buf;\\n  try {\\n    importScripts('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js');\\n    var data = new Uint8Array(buf);\\n    var wb = XLSX.read(data, { type: 'array' });\\n    var sheets = wb.SheetNames;\\n    var parsedBySheet = {};\\n    for (var i=0;i<sheets.length;i++){\\n      var s = sheets[i];\\n      var ws = wb.Sheets[s];\\n      var json = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });\\n      var headers = (json[0]||[]).map(function(h){ return String(h||'').trim(); });\\n      var rows = (json.slice(1)||[]).map(function(r){ var o = {}; headers.forEach(function(h,idx){ o[h] = r[idx] == null ? '' : r[idx]; }); return o; });\\n      parsedBySheet[s] = { headers: headers, data: rows };\\n    }\\n    postMessage({ok:true, sheets: sheets, parsedBySheet: parsedBySheet});\\n  } catch(err){\\n    postMessage({ok:false, error: String(err && err.message || err)});\\n  }\\n};";
        var blob = new Blob([workerCode], {type: 'application/javascript'});
        return new Worker(URL.createObjectURL(blob));
      } catch(e){
        return null;
      }
    }

    // === Toast hook-like ===
    function useToast(){
      const ReactUseState = React.useState;
      var _a = ReactUseState(''), msg = _a[0], setMsg = _a[1];
      var show = function(m){ setMsg(m); setTimeout(function(){ setMsg(''); }, 2200); };
      return {
        node: h('div', { className: 'toast' + (msg ? ' show' : ''), role:'status', 'aria-live':'polite' }, msg),
        show: show
      };
    }

    // === Virtual Table ===
    function VirtualTable(props){
      var headers = props.headers || [];
      var rows = props.rows || [];
      var rowClassFor = props.rowClassFor;
      var cellRender = props.cellRender;
      var rowH = 40;
      var ReactUseState = React.useState;
      var _a = ReactUseState(0), scrollTop = _a[0], setScrollTop = _a[1];
      var onScroll = function(e){ setScrollTop(e.currentTarget.scrollTop); };
      var total = rows.length;
      var viewportH = 520;
      var overscan = 8;
      var start = Math.max(0, Math.floor(scrollTop / rowH) - overscan);
      var visibleCount = Math.ceil(viewportH / rowH) + overscan*2;
      var end = Math.min(total, start + visibleCount);
      var topPad = start * rowH;
      var bottomPad = (total - end) * rowH;

      return h('div', { className:'table-wrap', onScroll:onScroll },
        h('table', null,
          h('thead', null,
            h('tr', null, headers.map(function(th){ return h('th', { key: th }, th); }))
          )
        ),
        h('div', { className:'spacer', style: {'--spacer-h': topPad + 'px'} }),
        h('table', null,
          h('tbody', null,
            rows.slice(start, end).map(function(row, i){
              var idx = start + i;
              var cls = rowClassFor ? rowClassFor(row, idx) : '';
              return h('tr', { key: idx, className: cls, style:{height: rowH} },
                headers.map(function(hh){ return h('td', { key: hh }, cellRender ? cellRender(row, hh) : (row[hh] != null ? row[hh] : '')); })
              );
            })
          )
        ),
        h('div', { className:'spacer', style: {'--spacer-h': bottomPad + 'px'} })
      );
    }

    function FilePicker(props){
      var id = props.id, file = props.file, onPick = props.onPick, onRemove = props.onRemove, sheets = props.sheets, activeSheet = props.activeSheet, onSheetChange = props.onSheetChange;
      var inputRef = React.useRef(null);
      var labelId = 'label-' + id;
      return h('div', { className:'card', 'aria-labelledby': labelId },
        h('div', { className:'card-title', id:labelId }, 'File ' + id),
        !file ? (
          h('button', { className:'file-drop', role:'button', onClick: function(){ if(inputRef.current) inputRef.current.click(); }, 'aria-label':'Seleziona file '+id },
            h('div', { style:{fontWeight:600, marginBottom:'.25rem'} }, 'Tocca/Clicca per selezionare'),
            h('div', { className:'muted' }, 'Supporta .xlsx, .xls, .csv'),
            h('input', { type:'file', style:{display:'none'}, accept:'.xlsx,.xls,.csv', ref:inputRef, onChange: function(e){ if(e.target.files && e.target.files[0]) onPick(e.target.files[0], id); } })
          )
        ) : (
          h(React.Fragment, null,
            h('div', { className:'file-info' },
              h('div', { style:{overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap'}, title:file.name }, file.name),
              h('div', { className:'toolbar' },
                (sheets && sheets.length>1) ? h('select', { 'aria-label':'Seleziona foglio per file '+id, value: activeSheet || sheets[0], onChange: function(e){ onSheetChange(id, e.target.value); } },
                  sheets.map(function(s){ return h('option', { key:s, value:s }, s); })
                ) : null,
                h('button', { className:'btn', onClick: function(){ onRemove(id); }, 'aria-label':'Rimuovi file '+id }, 'Rimuovi')
              )
            )
          )
        )
      );
    }

    function MappingModal(props){
      var open = props.open, onClose = props.onClose, headersA = props.headersA || [], headersB = props.headersB || [], mapAB = props.mapAB || {}, setMapAB = props.setMapAB;
      React.useEffect(function(){
        var onKey = function(e){ if(e.key==='Escape') onClose(); };
        if(open) window.addEventListener('keydown', onKey);
        return function(){ window.removeEventListener('keydown', onKey); };
      }, [open, onClose]);
      if(!open) return null;
      return h('div', { className:'overlay', onClick: function(e){ if(e.target.classList && e.target.classList.contains('overlay')) onClose(); } },
        h('div', { className:'modal', role:'dialog', 'aria-modal':'true', 'aria-label':'Mappa Colonne' },
          h('div', { className:'modal-h' },
            h('strong', null, 'Mappa Colonne'),
            h('button', { className:'btn', onClick: onClose }, 'Chiudi')
          ),
          h('div', { className:'modal-b' },
            h('p', { className:'muted', style:{marginBottom:'.75rem'} }, 'Abbina le colonne del File A con quelle del File B. Se non rilevante, seleziona "Ignora".'),
            headersA.map(function(hA){
              return h('div', { className:'map-row', key:hA },
                h('div', null, hA),
                h('div', null, 'â†’'),
                h('select', { value: mapAB[hA] || '', onChange: function(e){ var v={}; for (var k in mapAB) v[k]=mapAB[k]; v[hA]=e.target.value; setMapAB(v); } },
                  h('option', { value:'' }, 'Ignora'),
                  headersB.map(function(hh){ return h('option', { key:hh, value:hh }, hh); })
                )
              );
            }),
            h('div', { style:{display:'flex', justifyContent:'flex-end', marginTop:'1rem'} },
              h('button', { className:'btn primary', onClick:onClose }, 'Salva')
            )
          )
        )
      );
    }

    function App(){
      var ReactUseState = React.useState;
      var ReactUseMemo = React.useMemo;
      var ReactUseEffect = React.useEffect;

      // Tema
      var _d = ReactUseState(store.get('themeDark', false)), dark = _d[0], setDark = _d[1];
      ReactUseEffect(function(){ document.documentElement.classList.toggle('dark', dark); store.set('themeDark', dark); }, [dark]);

      var toast = useToast();

      // File & parsing
      var _f = ReactUseState({A:null,B:null}), files = _f[0], setFiles = _f[1];
      var _p = ReactUseState({A:null,B:null}), parsed = _p[0], setParsed = _p[1];
      var _s = ReactUseState({A:null,B:null}), activeSheet = _s[0], setActiveSheet = _s[1];
      var _e = ReactUseState(''), error = _e[0], setError = _e[1];
      var workerRef = React.useRef(null);

      var CAN_USE_WORKER = (typeof Worker !== 'undefined') && location.protocol !== 'file:';
      ReactUseEffect(function(){ if (CAN_USE_WORKER) workerRef.current = createParserWorker(); return function(){ if(workerRef.current) workerRef.current.terminate(); }; }, []);

      function parseMainThread(arrayBuffer, id, fileName){
        try {
          var data = new Uint8Array(arrayBuffer);
          var wb = XLSX.read(data, { type:'array' });
          var sheets = wb.SheetNames;
          var parsedBySheet = {};
          for (var i=0;i<sheets.length;i++){
            var s = sheets[i];
            var ws = wb.Sheets[s];
            var json = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
            var headers = (json[0]||[]).map(function(h){ return String(h||'').trim(); });
            var rows = (json.slice(1)||[]).map(function(r){ var o={}; headers.forEach(function(h,idx){ o[h] = (r[idx] == null ? '' : r[idx]); }); return o; });
            parsedBySheet[s] = { headers: headers, data: rows };
          }
          setParsed(function(p){ var np = Object.assign({}, p); np[id] = { sheets:sheets, parsedBySheet: parsedBySheet }; return np; });
          setActiveSheet(function(s){ var ns = Object.assign({}, s); ns[id] = sheets[0]; return ns; });
          toast.show('File '+id+' caricato: '+fileName);
        } catch(err){ setError('Errore parsing (main): '+ String(err && err.message || err)); }
      }

      function handlePick(file, id){
        setFiles(function(prev){ var nf = Object.assign({}, prev); nf[id]=file; return nf; });
        setError('');
        var fr = new FileReader();
        fr.onload = function(){
          if (CAN_USE_WORKER && workerRef.current){
            try {
              workerRef.current.onmessage = function(ev){
                var d = ev.data;
                if(!d.ok){ setError('Errore parsing (worker): '+d.error); parseMainThread(fr.result, id, file.name); return; }
                setParsed(function(p){ var np = Object.assign({}, p); np[id] = { sheets: d.sheets, parsedBySheet: d.parsedBySheet }; return np; });
                setActiveSheet(function(s){ var ns = Object.assign({}, s); ns[id] = d.sheets[0]; return ns; });
                toast.show('File '+id+' caricato: '+file.name);
              };
              workerRef.current.postMessage({ buf: fr.result });
            } catch(e){ parseMainThread(fr.result, id, file.name); }
          } else {
            parseMainThread(fr.result, id, file.name);
          }
        };
        fr.onerror = function(){ setError('Errore lettura file '+file.name); };
        fr.readAsArrayBuffer(file);
      }

      function handleRemove(id){ setFiles(function(f){ var nf=Object.assign({},f); nf[id]=null; return nf; }); setParsed(function(p){ var np=Object.assign({},p); np[id]=null; return np; }); }

      var dataA = ReactUseMemo(function(){ return (parsed.A && activeSheet.A) ? parsed.A.parsedBySheet[activeSheet.A] : null; }, [parsed.A, activeSheet.A]);
      var dataB = ReactUseMemo(function(){ return (parsed.B && activeSheet.B) ? parsed.B.parsedBySheet[activeSheet.B] : null; }, [parsed.B, activeSheet.B]);

      var _m = ReactUseState({}), mapAB = _m[0], setMapAB = _m[1];
      ReactUseEffect(function(){
        if (dataA && dataB){
          var m = {};
          (dataA.headers||[]).forEach(function(h){ if ((dataB.headers||[]).indexOf(h) >= 0) m[h]=h; });
          setMapAB(m);
        }
      }, [dataA, dataB]);

      var _opt = ReactUseState(store.get('cmpOptions', {ignoreCase:true, trimWhitespace:true})), options = _opt[0], setOptions = _opt[1];
      ReactUseEffect(function(){ store.set('cmpOptions', options); }, [options]);

      var _kc = ReactUseState(''), keyCol = _kc[0], setKeyCol = _kc[1];
      var _ex = ReactUseState(store.get('excludedCols', [])), excludedCols = _ex[0], setExcludedCols = _ex[1];
      ReactUseEffect(function(){ store.set('excludedCols', excludedCols); }, [excludedCols]);

      var _open = ReactUseState(false), openMap = _open[0], setOpenMap = _open[1];
      var _tab = ReactUseState('modified'), tab = _tab[0], setTab = _tab[1];
      var _diff = ReactUseState(null), diff = _diff[0], setDiff = _diff[1];
      var _busy = ReactUseState(false), busy = _busy[0], setBusy = _busy[1];
      var _q = ReactUseState(''), query = _q[0], setQuery = _q[1];

      var canCompare = !!(dataA && dataB && keyCol);

      function doCompare(){
        if (!canCompare) return;
        setBusy(true);
        setTimeout(function(){
          var res = buildDiff({A:dataA, B:dataB, keyColA:keyCol, mapAB:mapAB, options:options, excludedCols:excludedCols});
          setDiff(res);
          var firstTab = res.modified.length ? 'modified' : (res.added.length ? 'added' : 'removed');
          setTab(firstTab);
          setBusy(false);
          toast.show('Confronto completato');
        }, 10);
      }

      function textMatch(obj){
        if (!query) return true;
        var values = [];
        for (var k in obj) if (Object.prototype.hasOwnProperty.call(obj,k)) values.push(String(obj[k]));
        var text = values.join(' ').toLowerCase();
        return text.indexOf(query.toLowerCase()) >= 0;
      }

      var sets = ReactUseMemo(function(){
        if (!diff || !keyCol) return { mod:new Set(), add:new Set(), rem:new Set(), kB: mapAB[keyCol] };
        var kB = mapAB[keyCol];
        var mod = new Set(diff.modified.map(function(m){return m.key;}));
        var add = kB ? new Set(diff.added.map(function(r){return r[kB];})) : new Set();
        var rem = new Set(diff.removed.map(function(r){return r[keyCol];}));
        return { mod:mod, add:add, rem:rem, kB:kB };
      }, [diff, keyCol, mapAB]);

      var rowsAOrdered = ReactUseMemo(function(){
        if (!dataA) return [];
        var base = dataA.data.slice();
        if (!diff || !keyCol) return base;
        base.sort(function(a,b){
          function score(r){ return (sets.rem.has(r[keyCol]) || sets.mod.has(r[keyCol])) ? 1 : 0; }
          return score(b) - score(a);
        });
        return base;
      }, [dataA, diff, keyCol, sets]);

      var rowsBOrdered = ReactUseMemo(function(){
        if (!dataB) return [];
        var base = dataB.data.slice();
        if (!diff || !keyCol || !sets.kB) return base;
        var kB = sets.kB;
        base.sort(function(a,b){
          function score(r){ return (sets.add.has(r[kB]) || sets.mod.has(r[kB])) ? 1 : 0; }
          return score(b) - score(a);
        });
        return base;
      }, [dataB, diff, keyCol, sets]);

      var rowsAView = ReactUseMemo(function(){ return rowsAOrdered.filter(textMatch); }, [rowsAOrdered, query]);
      var rowsBView = ReactUseMemo(function(){ return rowsBOrdered.filter(textMatch); }, [rowsBOrdered, query]);

      var filtRows = ReactUseMemo(function(){
        if (!diff) return { modified: [], added: [], removed: [] };
        return {
          modified: diff.modified.filter(function(m){ return textMatch(m.rowDataB); }),
          added: diff.added.filter(textMatch),
          removed: diff.removed.filter(textMatch)
        };
      }, [diff, query]);

      var currentHeaders = ReactUseMemo(function(){
        if (tab === 'removed') return (dataA && dataA.headers) ? dataA.headers : [];
        if (tab === 'fileA') return (dataA && dataA.headers) ? dataA.headers : [];
        if (tab === 'fileB') return (dataB && dataB.headers) ? dataB.headers : [];
        return (dataB && dataB.headers) ? dataB.headers : [];
      }, [tab, dataA, dataB]);

      var currentRows = ReactUseMemo(function(){
        if (!diff && (tab==='fileA' || tab==='fileB')) return tab==='fileA' ? ((dataA && dataA.data) || []) : ((dataB && dataB.data) || []);
        if (tab==='modified') return filtRows.modified.map(function(m){ var o=Object.assign({}, m.rowDataB); o.__changes__=m.changes; return o; });
        if (tab==='added') return filtRows.added;
        if (tab==='removed') return filtRows.removed;
        if (tab==='fileA') return rowsAView;
        if (tab==='fileB') return rowsBView;
        return [];
      }, [diff, tab, filtRows, rowsAView, rowsBView, dataA, dataB]);

      function rowClassFor(row){
        if (tab==='modified') return 'row-mod';
        if (tab==='added') return 'row-add';
        if (tab==='removed') return 'row-rem';
        if (tab==='fileA'){
          if (!keyCol) return '';
          var k = row[keyCol];
          if (sets.rem.has(k)) return 'row-rem';
          if (sets.mod.has(k)) return 'row-mod';
          return '';
        }
        if (tab==='fileB'){
          if (!sets.kB) return '';
          var k2 = row[sets.kB];
          if (sets.add.has(k2)) return 'row-add';
          if (sets.mod.has(k2)) return 'row-mod';
          return '';
        }
        return '';
      }

      function cellRender(row, hkey){
        if (tab !== 'modified') return row[hkey] != null ? row[hkey] : '';
        var changes = row.__changes__ || [];
        var ch = changes.find(function(c){return c.headerB === hkey;});
        if (!ch) return row[hkey] != null ? row[hkey] : '';
        return h(React.Fragment, null,
          h('div', { className:'old' }, String(ch.oldValue == null ? '' : ch.oldValue)),
          h('div', { className:'new' }, String(ch.newValue == null ? '' : ch.newValue))
        );
      }

      function exportAll(){ if (diff) exportDiffExcel(diff); }
      function exportA(){ if (diff && dataA) exportSingleExcel('A', diff, {A:dataA,B:dataB}, keyCol, mapAB); }
      function exportB(){ if (diff && dataB) exportSingleExcel('B', diff, {A:dataA,B:dataB}, keyCol, mapAB); }

      return h('div', { className:'container' },
        h('header', { className:'header' },
          h('div', null,
            h('h1', null, 'Confronto File Excel'),
            h('p', { className:'muted' }, ' ')
          ),
          h('div', { className:'switch', title:'Tema scuro' },
            h('input', { type:'checkbox', id:'darkToggle', checked: dark, onChange: function(e){ setDark(e.target.checked); }}),
            h('label', { htmlFor:'darkToggle' }, 'Dark mode')
          )
        ),

        diff ? h('div', { className:'sticky-stats', role:'status', 'aria-live':'polite' },
          h('div', { className:'stats-bar' },
            h('div', { className:'pill modified' }, 'Modificati: ', String(diff.modified.length)),
            h('div', { className:'pill added' }, 'Aggiunti: ', String(diff.added.length)),
            h('div', { className:'pill removed' }, 'Rimossi: ', String(diff.removed.length))
          )
        ) : null,

        error ? h('div', { className:'alert', role:'alert' }, error) : null,

        h('div', { className:'row', style:{marginBottom:'1rem'} },
          h(FilePicker, { id:'A', file:files.A, onPick:handlePick, onRemove:handleRemove, sheets: parsed.A ? parsed.A.sheets : null, activeSheet: activeSheet.A, onSheetChange: function(id,val){ setActiveSheet(function(s){ var ns=Object.assign({},s); ns[id]=val; return ns; }); } }),
          h(FilePicker, { id:'B', file:files.B, onPick:handlePick, onRemove:handleRemove, sheets: parsed.B ? parsed.B.sheets : null, activeSheet: activeSheet.B, onSheetChange: function(id,val){ setActiveSheet(function(s){ var ns=Object.assign({},s); ns[id]=val; return ns; }); } })
        ),

        (dataA && dataB) ? h('div', { className:'card', 'aria-live':'polite' },
          h('div', { className:'toolbar', style:{justifyContent:'space-between', marginBottom:'.75rem'} },
            h('div', { className:'toolbar', style:{gap:'1rem'} },
              h('div', null,
                h('div', { className:'muted', style:{fontSize:'.85rem'} }, 'Colonna Chiave'),
                h('select', { value:keyCol, onChange:function(e){ setKeyCol(e.target.value); } },
                  h('option', { value:'' }, 'Seleziona'),
                  h('option', { value:'__CONTENT__', disabled:true }, 'Confronto contenuto'),
                  Object.keys(mapAB).map(function(hh){ return h('option', { key:hh, value:hh }, hh); })
                )
              ),
              h('div', null,
                h('div', { className:'muted', style:{fontSize:'.85rem'} }, 'Opzioni'),
                h('div', { className:'checkboxes' },
                  h('label', null, h('input', { type:'checkbox', checked: options.ignoreCase, onChange:function(e){ setOptions(Object.assign({}, options, {ignoreCase:e.target.checked})); } }), ' Ignora maiuscole'),
                  h('label', null, h('input', { type:'checkbox', checked: options.trimWhitespace, onChange:function(e){ setOptions(Object.assign({}, options, {trimWhitespace:e.target.checked})); } }), ' Ignora spazi')
                )
              ),
              h('div', null,
                h('div', { className:'muted', style:{fontSize:'.85rem'} }, 'Escludi colonne'),
                h('select', { multiple:true, size: Math.min(8, (dataB && dataB.headers ? dataB.headers.length : 0)), value: excludedCols, onChange: function(e){ var vals = Array.prototype.slice.call(e.target.selectedOptions).map(function(o){return o.value;}); setExcludedCols(vals); } },
                  Array.from(new Set([].concat((dataA && dataA.headers) ? dataA.headers : [], (dataB && dataB.headers) ? dataB.headers : []))).map(function(hh){ return h('option', { key:hh, value:hh }, hh); })
                )
              )
            ),
            h('div', { className:'toolbar' },
              h('button', { className:'btn', onClick:function(){ setOpenMap(true); } }, 'Mappa Colonne (', String(Object.keys(mapAB).filter(function(k){return mapAB[k];}).length), ')'),
              h('button', { className:'btn primary', onClick:doCompare, disabled: (!canCompare || busy) }, busy ? 'Confrontoâ€¦' : 'Esegui Confronto')
            )
          ),

          diff ? h(React.Fragment, null,
            h('div', { className:'actions' },
              h('div', { className:'tabs' },
                h('button', { className:'tab ' + (tab==='modified'?'active':''), onClick:function(){ setTab('modified'); } }, 'Modificati (', String(diff.modified.length), ')'),
                h('button', { className:'tab ' + (tab==='added'?'active':''), onClick:function(){ setTab('added'); } }, 'Aggiunti (', String(diff.added.length), ')'),
                h('button', { className:'tab ' + (tab==='removed'?'active':''), onClick:function(){ setTab('removed'); } }, 'Rimossi (', String(diff.removed.length), ')'),
                h('button', { className:'tab ' + (tab==='fileA'?'active':''), onClick:function(){ setTab('fileA'); } }, 'File A (tutti)'),
                h('button', { className:'tab ' + (tab==='fileB'?'active':''), onClick:function(){ setTab('fileB'); } }, 'File B (tutti)')
              ),
              h('div', { className:'search' },
                h('input', { placeholder:'Cercaâ€¦', value:query, onChange:function(e){ setQuery(e.target.value); } }),
                h('button', { className:'btn', onClick:exportAll }, 'Esporta differenze')
              )
            ),

            tab==='fileA' ? h('div', { className:'actions', style:{marginTop:'-.25rem'} },
              h('div', { className:'legend' }, 'ðŸŸ¡ Modificato â€¢ ðŸ”´ Rimosso â€¢ (ordinati in alto)'),
              h('div', { className:'toolbar' }, h('button', { className:'btn', onClick:exportA }, 'Esporta File A'))
            ) : null,
            tab==='fileB' ? h('div', { className:'actions', style:{marginTop:'-.25rem'} },
              h('div', { className:'legend' }, 'ðŸŸ¡ Modificato â€¢ ðŸŸ¢ Aggiunto â€¢ (ordinati in alto)'),
              h('div', { className:'toolbar' }, h('button', { className:'btn', onClick:exportB }, 'Esporta File B'))
            ) : null,

            h(VirtualTable, { headers: currentHeaders, rows: currentRows, rowClassFor: rowClassFor, cellRender: cellRender }),

            h('div', { className:'actions' },
              h('div', { className:'muted' }, 'Esporta singolo file con colonna di stato'),
              h('div', { className:'toolbar' },
                h('button', { className:'btn', onClick:exportA }, 'Esporta File A'),
                h('button', { className:'btn', onClick:exportB }, 'Esporta File B')
              )
            )
          ) : null
        ) : null,

        h('footer', { className:'footer' }, 'ðŸ’¡ Apri il file direttamente nel browser. Nessun transpiler richiesto. Tutto avviene in locale.'),
        toast.node,
        h(MappingModal, { open: openMap, onClose: function(){ setOpenMap(false); }, headersA: (dataA && dataA.headers) || [], headersB: (dataB && dataB.headers) || [], mapAB: mapAB, setMapAB: setMapAB })
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(h(App));
  })();
  </script>
</body>
</html>
